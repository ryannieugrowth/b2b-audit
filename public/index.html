<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Free Client Acquisition Audit ‚Äî Nieu Growth Strategies</title>
  <meta name="description" content="Get a free AI-powered audit of your client acquisition strategy. Discover gaps, get actionable quick wins, and learn how to lower your CAC.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Fraunces:ital,opsz,wght@0,9..144,400;0,9..144,600;1,9..144,400&display=swap" rel="stylesheet">
  
  <style>
    /* ===== RESET & VARIABLES ===== */
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --brand-dark: #00361F;
      --brand-primary: #006837;
      --brand-bright: #10B981;
      --brand-glow: #34D399;
      
      --bg: #020D08;
      --bg-glass: rgba(2, 13, 8, 0.7);
      --surface: #061E14;
      --surface-light: #0D2E20;
      
      --text: #F0FDF4;
      --text-secondary: #A7F3D0;
      --text-muted: #6EE7B7;
      
      --border: rgba(16, 185, 129, 0.15);
      --border-highlight: rgba(16, 185, 129, 0.3);
      --radius-sm: 8px;
      --radius-lg: 24px;
      --font-body: 'DM Sans', sans-serif;
      --font-display: 'Fraunces', serif;
    }

    html {
      scroll-behavior: smooth;
      -webkit-font-smoothing: antialiased;
    }

    body {
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      overflow-x: hidden;
      background-image: 
        radial-gradient(circle at 15% 50%, rgba(0, 104, 55, 0.15), transparent 25%),
        radial-gradient(circle at 85% 30%, rgba(16, 185, 129, 0.08), transparent 25%);
      background-attachment: fixed;
    }

    /* ===== UTILITIES ===== */
    .hidden { display: none !important; }
    
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-enter { animation: fadeUp 0.8s ease-out forwards; opacity: 0; }
    .delay-1 { animation-delay: 0.1s; }
    .delay-2 { animation-delay: 0.2s; }
    .delay-3 { animation-delay: 0.3s; }

    /* ===== NAV ===== */
    nav {
      position: fixed;
      top: 0; left: 0; right: 0; z-index: 100;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(2, 13, 8, 0.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
    }
    .logo {
      font-family: var(--font-display);
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .logo span { color: var(--brand-bright); font-style: italic; }
    
    .logo-icon {
      width: 20px;
      height: 20px;
      position: relative;
    }
    .logo-icon::after {
      content: '‚Üó';
      font-family: sans-serif;
      font-weight: bold;
      color: var(--text);
      font-size: 1.4rem;
      line-height: 1;
      position: absolute;
      top: -2px; left: 0;
    }

    .nav-cta {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--brand-dark);
      background: var(--brand-bright);
      text-decoration: none;
      padding: 8px 20px;
      border-radius: 100px;
      transition: all 0.2s;
      box-shadow: 0 0 15px rgba(16, 185, 129, 0.2);
    }
    .nav-cta:hover {
      background: #fff;
      transform: translateY(-1px);
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
    }

    /* ===== HERO ===== */
    .hero {
      position: relative;
      padding: 140px 24px 60px;
      text-align: center;
      max-width: 800px;
      margin: 0 auto;
    }
    .hero-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 16px;
      background: rgba(0, 104, 55, 0.3);
      border: 1px solid var(--border);
      border-radius: 100px;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--brand-bright);
      margin-bottom: 24px;
    }
    .dot-pulse {
      width: 6px; height: 6px; background: var(--brand-bright); border-radius: 50%;
      box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
      animation: pulse-green 2s infinite;
    }
    @keyframes pulse-green {
      0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
      70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
      100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }

    .hero h1 {
      font-family: var(--font-display);
      font-size: clamp(2.5rem, 6vw, 4rem);
      line-height: 1.1;
      margin-bottom: 24px;
      color: #fff;
    }
    .hero h1 em {
      color: var(--brand-bright);
      font-style: normal;
      position: relative;
    }
    .hero h1 em::after {
      content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 6px;
      background: var(--brand-primary); opacity: 0.6; z-index: -1; transform: skewX(-10deg);
    }

    .hero p {
      font-size: 1.1rem;
      color: var(--text-secondary);
      max-width: 580px;
      margin: 0 auto 40px;
    }

    /* ===== PROOF BAR ===== */
    .proof-strip {
      display: flex;
      justify-content: center;
      gap: 2rem;
      padding: 24px;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      background: rgba(0, 54, 31, 0.3);
      backdrop-filter: blur(5px);
    }
    .proof-item { text-align: center; padding: 0 16px; }
    .proof-number {
      font-family: var(--font-display);
      font-size: 1.8rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 4px;
    }
    .proof-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    /* ===== CHAT SECTION ===== */
    .chat-section {
      max-width: 900px;
      margin: 0 auto;
      padding: 60px 20px 80px;
    }
    
    .chat-container {
      background: rgba(6, 30, 20, 0.6);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border-highlight);
      border-radius: var(--radius-lg);
      box-shadow: 0 20px 50px rgba(0,0,0,0.5), 0 0 0 1px rgba(16,185,129,0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 650px;
      position: relative;
    }

    .chat-header {
      padding: 20px 24px;
      background: rgba(0, 54, 31, 0.5);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .avatar-ai {
      width: 32px; height: 32px;
      background: linear-gradient(135deg, #fff, var(--brand-bright));
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; color: var(--brand-dark); font-size: 14px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .chat-messages::-webkit-scrollbar { width: 4px; }
    .chat-messages::-webkit-scrollbar-track { background: transparent; }
    .chat-messages::-webkit-scrollbar-thumb { background: var(--border-highlight); border-radius: 10px; }
    
    .msg {
      max-width: 85%;
      padding: 16px 20px;
      border-radius: 18px;
      font-size: 0.95rem;
      line-height: 1.6;
      position: relative;
      animation: fadeUp 0.3s ease-out;
    }
    .msg--ai {
      background: var(--surface-light);
      border: 1px solid var(--border);
      color: var(--text);
      border-bottom-left-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .msg--user {
      background: var(--brand-primary);
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      box-shadow: 0 4px 15px rgba(0, 104, 55, 0.4);
    }

    /* Markdown content inside AI messages */
    .msg--ai p { margin-bottom: 8px; }
    .msg--ai p:last-child { margin-bottom: 0; }
    .msg--ai strong { color: #fff; font-weight: 600; }
    .msg--ai em { color: var(--brand-bright); font-style: italic; }
    .msg--ai h3, .msg--ai h4 {
      color: #fff;
      margin: 16px 0 8px;
      font-size: 1rem;
      font-weight: 700;
    }
    .msg--ai h3:first-child, .msg--ai h4:first-child { margin-top: 0; }
    .msg--ai ul, .msg--ai ol {
      margin: 8px 0 12px 20px;
      padding: 0;
    }
    .msg--ai li {
      margin-bottom: 6px;
      line-height: 1.5;
    }
    .msg--ai li::marker {
      color: var(--brand-bright);
    }
    .msg--ai hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 12px 0;
    }

    .chat-input-area {
      padding: 16px 24px;
      background: var(--surface);
      border-top: 1px solid var(--border);
    }
    .chat-input-wrap {
      display: flex;
      gap: 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px 8px 8px 16px;
      transition: border-color 0.2s;
    }
    .chat-input-wrap:focus-within { border-color: var(--brand-bright); }
    
    .chat-input {
      flex: 1;
      background: transparent;
      border: none;
      color: #fff;
      font-family: inherit;
      font-size: 1rem;
      resize: none;
      outline: none;
      padding: 8px 0;
      max-height: 100px;
    }
    .chat-input::placeholder { color: rgba(167, 243, 208, 0.4); }
    .chat-send {
      width: 44px; height: 44px;
      background: var(--brand-bright);
      border: none; border-radius: 8px;
      color: var(--brand-dark);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.2s;
      flex-shrink: 0;
    }
    .chat-send:hover { transform: scale(1.05); background: #fff; }
    .chat-send:disabled { background: var(--surface-light); color: var(--text-muted); cursor: default; transform: none; }

    /* START OVERLAY */
    .chat-start-overlay {
      position: absolute;
      inset: 0;
      background: rgba(2, 13, 8, 0.4);
      backdrop-filter: blur(8px);
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .chat-start-btn {
      padding: 18px 40px;
      background: var(--brand-primary);
      border: 1px solid var(--brand-bright);
      border-radius: 100px;
      color: #fff;
      font-family: var(--font-body);
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 0 30px rgba(0, 104, 55, 0.6);
      transition: all 0.25s;
      display: flex; align-items: center; gap: 10px;
    }
    .chat-start-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 40px rgba(16, 185, 129, 0.5);
      background: var(--brand-bright);
      color: var(--brand-dark);
    }

    /* TYPING INDICATOR */
    .typing { display: flex; gap: 5px; padding: 12px 16px; width: fit-content; background: var(--surface-light); border-radius: 12px; border-bottom-left-radius: 4px; }
    .typing-dot { width: 6px; height: 6px; background: var(--text-muted); border-radius: 50%; animation: bounce 1.4s infinite; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); opacity: 0.5; } 50% { transform: translateY(-5px); opacity: 1; } }

    /* BOOKING BUTTON IN CHAT */
    .inline-book-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 14px;
      padding: 12px 24px;
      background: #fff;
      color: var(--brand-dark);
      font-family: var(--font-body);
      font-weight: 700;
      font-size: 0.9rem;
      text-decoration: none;
      border-radius: 50px;
      cursor: pointer;
      border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transition: all 0.15s;
    }
    .inline-book-btn:hover { background: var(--brand-bright); transform: scale(1.03); }

    /* ===== HOW IT WORKS ===== */
    .how-section { padding: 40px 24px 80px; max-width: 900px; margin: 0 auto; text-align: center; }
    .how-section h2 { font-family: var(--font-display); font-size: 2rem; margin-bottom: 40px; }
    .how-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
    .how-card {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 30px 20px;
      border-radius: 16px;
      transition: transform 0.3s;
    }
    .how-card:hover { transform: translateY(-5px); border-color: var(--brand-primary); }
    .how-num {
      width: 40px; height: 40px; margin: 0 auto 20px;
      background: var(--surface-light); color: var(--brand-bright);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-family: var(--font-display); font-weight: 700; border: 1px solid var(--border);
    }

    /* ===== FOOTER ===== */
    footer { padding: 40px; text-align: center; border-top: 1px solid var(--border); color: var(--text-muted); font-size: 0.85rem; }
    footer a { color: var(--text-secondary); }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .hero h1 { font-size: 2.8rem; }
      .proof-strip { flex-wrap: wrap; gap: 1.5rem; }
      .proof-item { width: 45%; }
      .how-grid { grid-template-columns: 1fr; }
      
      .chat-container {
        height: 75vh;
        height: 75dvh;
        border-radius: 16px;
      }
      .msg { max-width: 90%; padding: 12px 16px; }
      .chat-header { padding: 12px 16px; }
      .chat-input-area { padding: 12px 16px; }
    }
  </style>
</head>
<body>

  <nav class="animate-enter">
    <a href="https://nieugrowth.com" class="logo"><img src="/logo.png" alt="Nieu Growth Strategies" style="height:72px;"></a>
    <a href="#audit" class="nav-cta">Start Audit</a>
  </nav>

  <section class="hero">
    <div class="hero-badge animate-enter delay-1">
      <div class="dot-pulse"></div>
      Free AI Audit ‚Äî Takes 3 minutes
    </div>
    <h1 class="animate-enter delay-2">Is your client acquisition <em>actually</em> working?</h1>
    <p class="animate-enter delay-3">Get an instant, data-driven assessment of your strategy. Identify leaks, find quick wins, and optimize for revenue.</p>
  </section>

  <div class="proof-strip animate-enter delay-3">
    <div class="proof-item">
      <div class="proof-number">5-25%</div>
      <div class="proof-label">Response Rates</div>
    </div>
    <div class="proof-item">
      <div class="proof-number">24/7</div>
      <div class="proof-label">Confidential Analysis</div>
    </div>
    <div class="proof-item">
      <div class="proof-number">B2B</div>
      <div class="proof-label">Strategy Focus</div>
    </div>
  </div>

  <section class="chat-section" id="audit">
    <div class="chat-container">
      
      <div class="chat-start-overlay" id="startOverlay">
        <button class="chat-start-btn" id="startBtn">
          <span>Analyze My Strategy</span>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
        </button>
        <p style="margin-top:16px; font-size:0.85rem; color:var(--text-muted);">No email required to start</p>
      </div>

      <div class="chat-header">
        <div class="avatar-ai">N</div>
        <div>
          <div style="font-weight:600; font-size:0.95rem; color:#fff;">Nieu Growth AI</div>
          <div style="font-size:0.75rem; color:var(--brand-bright);">‚óè Online</div>
        </div>
      </div>

      <div class="chat-messages" id="chatMessages"></div>

      <div class="chat-input-area">
        <div class="chat-input-wrap">
          <textarea class="chat-input" id="chatInput" placeholder="Type your answer..." rows="1" disabled></textarea>
          <button class="chat-send" id="sendBtn" disabled>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
          </button>
        </div>
      </div>
    </div>
  </section>

  <section class="how-section">
    <h2>How It Works</h2>
    <div class="how-grid">
      <div class="how-card">
        <div class="how-num">1</div>
        <h3>Chat with AI</h3>
        <p style="color:var(--text-secondary); font-size:0.9rem;">Answer dynamic questions about your current acquisition channels and friction points.</p>
      </div>
      <div class="how-card">
        <div class="how-num">2</div>
        <h3>Instant Audit</h3>
        <p style="color:var(--text-secondary); font-size:0.9rem;">Our model identifies gaps and compares your metrics against industry benchmarks.</p>
      </div>
      <div class="how-card">
        <div class="how-num">3</div>
        <h3>Get Action Plan</h3>
        <p style="color:var(--text-secondary); font-size:0.9rem;">Receive immediate "quick wins" and an option to book a deep-dive strategy call.</p>
      </div>
    </div>
  </section>

  <footer>
    &copy; 2026 Nieu Growth Strategies ¬∑ <a href="https://nieugrowth.com">nieugrowth.com</a>
  </footer>

  <!-- Booking confirmation modal -->
  <div id="bookingModal" class="hidden" style="position:fixed; inset:0; z-index:999; background:rgba(0,0,0,0.8); backdrop-filter:blur(5px); display:flex; align-items:center; justify-content:center; padding:20px;">
    <div style="background:var(--surface); border:1px solid var(--border); padding:40px; border-radius:24px; max-width:400px; text-align:center;">
      <div style="font-size:3rem; margin-bottom:10px;">üóìÔ∏è</div>
      <h3 style="color:#fff; margin-bottom:10px;">Booking Page Opened</h3>
      <p style="color:var(--text-secondary); margin-bottom:24px;">The calendar has opened in a new tab. Select a time that works for you and Ryan will walk through your audit results.</p>
      <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
        <a href="https://calendar.google.com/calendar/u/0/appointments/schedules/AcZssZ2iDXx_E4TuVw4Qi3kcnMErY-UVL8u5c7WGwf_4IUC21KxVgpEX7wcITd0HmzpFQh8UaZZHlz0v" target="_blank" rel="noopener" style="padding:12px 24px; background:var(--brand-bright); color:var(--brand-dark); font-weight:700; font-family:var(--font-body); font-size:0.88rem; border-radius:50px; text-decoration:none; transition:all 0.15s;">Open booking again</a>
        <button onclick="document.getElementById('bookingModal').classList.add('hidden')" style="padding:12px 24px; background:transparent; border:1px solid var(--border); color:var(--text); border-radius:50px; cursor:pointer; font-family:var(--font-body); font-size:0.88rem;">Close</button>
      </div>
    </div>
  </div>

  <script>
    // ===== CHAT ENGINE =====
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const startOverlay = document.getElementById('startOverlay');
    const startBtn = document.getElementById('startBtn');
    const bookingModal = document.getElementById('bookingModal');
    
    let history = [];
    let isProcessing = false;

    // --- Textarea auto-resize ---
    const autoResize = () => {
      chatInput.style.height = 'auto';
      chatInput.style.height = Math.min(chatInput.scrollHeight, 100) + 'px';
    };

    const scrollToBottom = () => {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    // --- Markdown Parser ---
    // Handles: **bold**, *italic*, ### headers, - unordered lists, 
    // 1. ordered lists, \n\n paragraphs, --- hr
    function parseMarkdown(text) {
      // Normalize line endings
      text = text.replace(/\r\n/g, '\n');

      // Split into blocks by double newline
      const blocks = text.split(/\n{2,}/);
      let html = '';

      for (let block of blocks) {
        block = block.trim();
        if (!block) continue;

        // Horizontal rule
        if (/^-{3,}$/.test(block)) {
          html += '<hr>';
          continue;
        }

        // Header (### or ##)
        if (/^#{2,4}\s/.test(block)) {
          const level = block.match(/^(#{2,4})/)[1].length;
          const text = block.replace(/^#{2,4}\s+/, '');
          html += `<h${level}>${inlineFormat(text)}</h${level}>`;
          continue;
        }

        // Unordered list (lines starting with - or * or ‚Ä¢)
        if (/^[-*‚Ä¢]\s/m.test(block) && block.split('\n').every(l => /^[-*‚Ä¢]\s/.test(l.trim()) || l.trim() === '')) {
          const items = block.split('\n')
            .map(l => l.trim())
            .filter(l => l)
            .map(l => `<li>${inlineFormat(l.replace(/^[-*‚Ä¢]\s+/, ''))}</li>`)
            .join('');
          html += `<ul>${items}</ul>`;
          continue;
        }

        // Ordered list (lines starting with number.)
        if (/^\d+\.\s/m.test(block) && block.split('\n').every(l => /^\d+\.\s/.test(l.trim()) || l.trim() === '')) {
          const items = block.split('\n')
            .map(l => l.trim())
            .filter(l => l)
            .map(l => `<li>${inlineFormat(l.replace(/^\d+\.\s+/, ''))}</li>`)
            .join('');
          html += `<ol>${items}</ol>`;
          continue;
        }

        // Mixed content block ‚Äî may have headers + list items + text
        // Check line by line
        const lines = block.split('\n');
        let inList = false;
        let listType = null;
        let listItems = [];
        let paragraphLines = [];

        const flushList = () => {
          if (listItems.length > 0) {
            const tag = listType === 'ol' ? 'ol' : 'ul';
            html += `<${tag}>${listItems.join('')}</${tag}>`;
            listItems = [];
            listType = null;
            inList = false;
          }
        };

        const flushParagraph = () => {
          if (paragraphLines.length > 0) {
            html += `<p>${inlineFormat(paragraphLines.join('<br>'))}</p>`;
            paragraphLines = [];
          }
        };

        for (const line of lines) {
          const trimmed = line.trim();

          // Header line within a block
          if (/^#{2,4}\s/.test(trimmed)) {
            flushList();
            flushParagraph();
            const lvl = trimmed.match(/^(#{2,4})/)[1].length;
            const txt = trimmed.replace(/^#{2,4}\s+/, '');
            html += `<h${lvl}>${inlineFormat(txt)}</h${lvl}>`;
            continue;
          }

          // Unordered list item
          if (/^[-*‚Ä¢]\s/.test(trimmed)) {
            flushParagraph();
            if (listType === 'ol') flushList();
            inList = true;
            listType = 'ul';
            listItems.push(`<li>${inlineFormat(trimmed.replace(/^[-*‚Ä¢]\s+/, ''))}</li>`);
            continue;
          }

          // Ordered list item
          if (/^\d+\.\s/.test(trimmed)) {
            flushParagraph();
            if (listType === 'ul') flushList();
            inList = true;
            listType = 'ol';
            listItems.push(`<li>${inlineFormat(trimmed.replace(/^\d+\.\s+/, ''))}</li>`);
            continue;
          }

          // Regular text line
          flushList();
          if (trimmed) {
            paragraphLines.push(trimmed);
          }
        }

        flushList();
        flushParagraph();
      }

      return html;
    }

    // Inline formatting: **bold**, *italic*
    function inlineFormat(text) {
      return text
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>');
    }

    // --- Message Rendering ---
    const appendMessage = (text, sender) => {
      const msgDiv = document.createElement('div');
      msgDiv.className = `msg msg--${sender}`;
      
      if (sender === 'ai') {
        msgDiv.innerHTML = parseMarkdown(text);

        // Check for booking-related content in the assessment
        // Only trigger on clear booking/strategy call mentions near end of conversation
        if (/\b(book|booking|strategy call|deep-dive|30-minute)\b/i.test(text) && history.length >= 8) {
          const btn = document.createElement('button');
          btn.className = 'inline-book-btn';
          btn.textContent = 'üìÖ Book Strategy Call';
          btn.addEventListener('click', openBooking);
          msgDiv.appendChild(btn);
        }
      } else {
        msgDiv.textContent = text;
      }
      
      chatMessages.appendChild(msgDiv);
      scrollToBottom();
    };

    // --- Typing Indicator ---
    const showTyping = () => {
      const typeDiv = document.createElement('div');
      typeDiv.className = 'typing';
      typeDiv.id = 'typingIndicator';
      typeDiv.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
      chatMessages.appendChild(typeDiv);
      scrollToBottom();
    };
    
    const removeTyping = () => {
      const el = document.getElementById('typingIndicator');
      if (el) el.remove();
    };

    // --- Helper: delay ---
    const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    // --- Render multiple parts sequentially ---
    async function renderPartsSequentially(parts) {
      // Store the full combined text in history for the API
      const fullText = parts.join('\n\n');
      history.push({ role: 'assistant', content: fullText });

      for (let i = 0; i < parts.length; i++) {
        // Show brief typing indicator between parts
        if (i > 0) {
          showTyping();
          await delay(600 + Math.random() * 400); // 600-1000ms between parts
          removeTyping();
        }
        appendMessage(parts[i], 'ai');
      }
    }

    // --- API Communication ---
    async function sendMessage(text, isHidden) {
      if (!text || isProcessing) return;
      isProcessing = true;
      
      chatInput.value = '';
      chatInput.disabled = true;
      sendBtn.disabled = true;
      
      // Only show user message if not hidden (i.e. not the initial trigger)
      if (!isHidden) {
        appendMessage(text, 'user');
      }
      
      showTyping();

      // Add to history for the API
      history.push({ role: 'user', content: text });

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages: history })
        });
        
        const data = await response.json();
        removeTyping();
        
        if (data.parts && data.parts.length > 0) {
          // Multi-part assessment ‚Äî render sequentially
          await renderPartsSequentially(data.parts);
        } else if (data.reply) {
          // Normal single message
          history.push({ role: 'assistant', content: data.reply });
          appendMessage(data.reply, 'ai');
        } else {
          appendMessage("I encountered an error. Please try again.", 'ai');
        }
        
      } catch (error) {
        console.error(error);
        removeTyping();
        appendMessage("Connection error. Please check your internet and try again.", 'ai');
      }

      isProcessing = false;
      chatInput.disabled = false;
      sendBtn.disabled = false;
      chatInput.focus();
    }

    // --- Event Listeners ---
    startBtn.addEventListener('click', () => {
      startOverlay.classList.add('hidden');
      chatInput.disabled = false;
      chatInput.focus();
      // Hidden trigger ‚Äî user doesn't see "Start the audit" in chat
      sendMessage("Hi, I'd like to start the audit.", true);
    });

    chatInput.addEventListener('input', autoResize);
    
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const text = chatInput.value.trim();
        if (text) sendMessage(text, false);
      }
    });

    sendBtn.addEventListener('click', () => {
      const text = chatInput.value.trim();
      if (text) sendMessage(text, false);
    });

    // --- Booking ---
    function openBooking() {
      window.open('https://calendar.google.com/calendar/u/0/appointments/schedules/AcZssZ2iDXx_E4TuVw4Qi3kcnMErY-UVL8u5c7WGwf_4IUC21KxVgpEX7wcITd0HmzpFQh8UaZZHlz0v', '_blank');
      bookingModal.classList.remove('hidden');
    }
    
    // Close modal on background click
    bookingModal.addEventListener('click', (e) => {
      if (e.target === bookingModal) bookingModal.classList.add('hidden');
    });
  </script>
</body>
</html>
